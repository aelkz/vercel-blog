---
title: "App N-Tier com Keycloak no Red Hat Openshift Container Platform üáßüá∑"
publishedDate: "2018-10-17"
lastUpdatedDate: "2018-10-17"
tags:
  - technology
description: "Red Hat Openshift Single Sign-On Secured N-tier application deployment guide for 3-tier applications."
status: published
---

# Red Hat Openshift Single Sign-On Secured N-tier application

Refer√™ncia: [https://github.com/mechevarria/ocp-sso.git](https://github.com/mechevarria/ocp-sso.git)

Este projeto cont√©m scripts e c√≥digos-fonte para implantar uma aplica√ß√£o de 3 camadas utilizando o [Red Hat Single Sign-On](https://access.redhat.com/products/red-hat-single-sign-on) e protegendo-a com SSL.

A aplica√ß√£o √© distribu√≠da em uma app frontend (tier 1) [node.js](https://nodejs.org/en/) + [angular 6.x](https://angular.io/) que realiza a chamada para uma app back-end REST (tier 2) [springboot](http://spring.io/projects/spring-boot) e uma app back-end REST (tier 2) [JBoss EAP](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/) que ir√° persistir em uma inst√¢ncia de banco de dados (tier 3) [postgresql](https://www.postgresql.org/).

A implanta√ß√£o do Red Hat Single Sign-On ir√° atuar na prote√ß√£o deste cen√°rio atrav√©s de uma realm chamada **java-js-realm**. A realm ir√° conter clients configurados para o p√∫blico que enxergam o frontend (js) e o back-end do tipo bearer only (eap). O objetivo deste cen√°rio √© simples e se trata apenas de garantir que **um usu√°rio v√°lido est√° devidamente logado**.

Todos os scripts que ir√£o auxiliar o deployment das aplica√ß√µes requerem que voc√™ j√° esteja devidamente autenticado utlizando o cli da inst√¢ncia do cluster openshift [oc](https://docs.openshift.com/container-platform/3.10/cli_reference/get_started_cli.html) [openshift](https://www.openshift.com/)

Exemplo: oc login -u developer

![](/images/app-n-tier-com-keycloak-no-red-hat-openshift-container-platform/b01.png)

## Deploy Red Hat Single Sign-On

Navegue para o diret√≥rio sso e execute o script ocp-deploy-sso.sh.

Uma vez finalizado a execu√ß√£o voc√™ ir√° visualizar os pods criados no projeto **SSO N-tier**.

Os dados para login do console administrativo do RH-SSO s√£o **admin/Redhat1!**

**OBS**. Talvez seja necess√°rio importar as imagens oficiais do Red Hat Single Sign-On caso n√£o existam no registry do OCP. Para isso, execute o script ocp-install-templates.sh que se encontra no diret√≥rio de instala√ß√£o sso.

![](/images/app-n-tier-com-keycloak-no-red-hat-openshift-container-platform/b02.png)

### Set the Public Key in the config map

Certifique-se que a inst√¢ncia do RH-SSO est√° ativa (running). Uma vez que a inst√¢ncia estiver UP voc√™ ir√° precisar modificar o [config map](https://docs.openshift.com/container-platform/3.10/dev_guide/configmaps.html) utilizado pelo back-end do JBoss EAP para se comunicar com o Red Hat Single Sign-On.

- Acesse o console administrativo do RH-SSO. As credenciais para acesso s√£o **admin/Redhat1!**

- No **console administrativo do RH-SSO**, navegue para a **java-js-realm**, na aba **keys** e selecione **Public Key** na chave **RSA** e guarde o valor gerado na popup em um bloco de notas para utiliza√ß√£o futura.

![](/images/app-n-tier-com-keycloak-no-red-hat-openshift-container-platform/b03.png)

- Retorne para o console administrativo do Openshift.
  No projeto **SSO N-Tier**, navegue para **Resources** e depois em **Config Maps**

- Edite o config-map **ntier-config** e copie o valor previamente copiado no bloco de notas para a entrada **PUBLIC_KEY** (previamente definido com o valor **changeme**)

![](/images/app-n-tier-com-keycloak-no-red-hat-openshift-container-platform/b04.png)

## Deploy JBoss EAP and Postgresql

Navegue para o diret√≥rio eap e execute o script ocp-deploy-eap.sh.

Este script ir√° criar a aplica√ß√£o de back-end **bearer-only** que ir√° fazer uso do banco de dados PostgreSQL.

## Deploy Spring Boot

Navegue para o diret√≥rio springboot e execute o script ocp-deploy-springboot.sh.
Este script ir√° criar a aplica√ß√£o de back-end **confidential** que servir√° as requisi√ß√µes da aplica√ß√£o de front-end baseada em NodeJS/Angular.

## Deploy node.js

Agora que as camadas tier-2 e tier-3 est√£o dispon√≠veis, navegue para o diret√≥rio node e execute o script ocp-deploy-node.sh.

Este script ir√° criar a aplica√ß√£o front-end **public** baseada em NodeJS que ir√° realizar a interface final com o usu√°rio e ser√° respons√°vel pelo processo de login/logout integrado ao RH-SSO.

## Configure Clients

Agora que todas as aplica√ß√µes est√£o em execu√ß√£o (running), √© hora de configurar as aplica√ß√µes no console administrativo do RH-SSO.

Efetue o acesso ao console administrativo do RH-SSO.

Lembre-se de utilizar as credenciais **admin/Redhat1!**

### JS Client (front-end)

- Acesse a realm **java-js-realm**, selecione o item de menu **clients**, e acione o bot√£o **create**

- Informe o valor **js** no campo **Client ID**, e clique em **save**

- Informe em **Valid Redirect URIs** a rota que o Openshift criou para a aplica√ß√£o NodeJS e informe tamb√©m a URI **/\***. Exemplo: https://nodejs-app-ntier.192.168.42.90.nip.io/_ e /_

- Informe o valor _ em **Web Origins** (Access-Control-Allow-Origin: _). Maiores detalhes sobre CORS poder√£o ser vistos em [CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)

- Selecione a op√ß√£o **save**

![](/images/app-n-tier-com-keycloak-no-red-hat-openshift-container-platform/b05.png)

## Java Client (back-end bearer-only)

- Acesse a realm **java-js-realm**, selecione o item de menu **clients**, e acione o bot√£o **create**

- Informe o valor **java** no campo **Client ID**, e clique em **save**

- Informe a op√ß√£o **bearer-only** para o campo **Access Type**

- Selecione a op√ß√£o **save**

## Create User

- Acesse a realm **java-js-realm**, selecione o item de menu **Users**, e acione o bot√£o **Add User**

- Preencha os campos **Username**, **Email**, **First Name** and **Last Name**

- Selecione a op√ß√£o **save**

- Ainda na p√°gina do usu√°rio rec√©m-criado, navegue para a aba **Credentials**, e informe uma nova senha nos campos **New Password** e **Password Confirmation**

- Defina a op√ß√£o **temporary** para **off**

- Selecione a op√ß√£o **Reset Password**

- Confirme a opera√ß√£o acionando o bot√£o vermelho **Change the password**

## Test!

Agora que toda a parte de configura√ß√£o foi realizada, acesse a rota da aplica√ß√£o **node-js** e se tudo estiver de acordo, voc√™ ser√° redirecionado para a p√°gina de login provida pela integra√ß√£o da aplica√ß√£o NodeJS/Angular com o RH-SSO.

Informe o usu√°rio e senha previamente criados.

Ao acessar a aplica√ß√£o, voc√™ ser√° capaz de visualizar os atributos do usu√°rio rec√©m logado no item de menu **Profile**.

Utilizando os itens de menu **Status** e **Cars** voc√™ ser√° capaz de realizar chamadas para a aplica√ß√£o JBoss EAP back-end REST.

![](/images/app-n-tier-com-keycloak-no-red-hat-openshift-container-platform/b06-1.png)
